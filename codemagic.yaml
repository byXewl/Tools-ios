workflows:
  unsigned-swift-build:
    name: Unsigned Swift Build
    environment:
      xcode: 15.4
    scripts:
      - name: Resolve SPM & Pods
        script: |
          # 如果用 CocoaPods
          [ -f Podfile ] && pod install --repo-update
          # 拉取 SPM 依赖
          xcodebuild -resolvePackageDependencies -workspace Tools.xcworkspace -scheme Tools
      - name: Build .app (Release, 无签名)
        script: |
          xcodebuild archive \
            -workspace Tools.xcworkspace \
            -scheme Tools \
            -configuration Release \
            -archivePath build/ios/Tools.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE_SPECIFIER=""
      - name: Export .app
        script: |
          # 1. 找到 archive 生成的真实 .app 路径
          APP_PATH=$(find ~/Library/Developer/Xcode/DerivedData/*/Build/Intermediates.noindex/ArchiveIntermediates/*/InstallationBuildProductsLocation/Applications -name 'Tools.app' | head -n 1)
          mkdir -p build/ios/iphoneos
          cp -R "$APP_PATH" build/ios/iphoneos/
          cd build/ios/iphoneos
          zip -r Tools.app.zip Tools.app
    artifacts:
      - build/ios/iphoneos/*.app.zip